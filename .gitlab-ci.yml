stages:
  - lint
 # - test
  - build
  - deploy

variables:
  # Image f√ºr alle Jobs (leichtes Python-Image)
  PYTHON_IMAGE: "python:3.11-slim"

# ----------------------------------------------------------------------
# üßπ 1. Code-Qualit√§t pr√ºfen
# ----------------------------------------------------------------------
lint:
  stage: lint
  image: $PYTHON_IMAGE
  before_script:
    - pip install ruff
  script:
    - echo "üîç Running code linting with ruff..."
    - ruff check src/
  allow_failure: false

# ----------------------------------------------------------------------
# üß™ 2. Unit-Tests ausf√ºhren
# ----------------------------------------------------------------------
#test:
 # stage: test
#  image: $PYTHON_IMAGE
#  before_script:
#    - pip install flask requests pytest
#  script:
#    - echo "üß™ Running unit tests..."
#    - pytest --maxfail=1 --disable-warnings -q --junitxml=report.xml
#  artifacts:
 #   when: always
 #   reports:
  #    junit: report.xml

# ----------------------------------------------------------------------
# üê≥ 3. Container bauen und pushen
# ----------------------------------------------------------------------
build:
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_DRIVER: overlay2
    IMAGE_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
  before_script:
    - echo "üîê Login to GitLab Container Registry"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  script:
    - echo "üê≥ Building Docker image..."
    - docker build -t "$IMAGE_TAG" src/
    - docker push "$IMAGE_TAG"
  only:
    - main
    - merge_requests
